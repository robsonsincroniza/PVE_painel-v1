<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Prioridades PVE | Desenvolvimento de Municípios</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- PapaParse para futura leitura do Google Sheets CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom Styles & Palette -->
    <style>
        :root {
            --color-bg: #F8FAFC;        
            --color-text-main: #1E293B; 
            --level-fragil: #EF4444;       
            --level-consolidacao: #F59E0B; 
            --level-consolidado: #10B981;  
            --level-robusto: #3B82F6;      
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text-main);
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 1000px; 
            margin-left: auto;
            margin-right: auto;
            min-height: 300px;
        }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Transition classes for smooth UI updates */
        .fade-update { transition: opacity 0.3s ease-in-out; }
    </style>
</head>
<body class="antialiased pb-24">

    <!-- Navigation / Header -->
    <nav class="bg-white shadow-sm sticky top-0 z-50 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <span class="text-3xl mr-2 text-blue-700 font-bold tracking-tighter">PVE</span>
                    <span class="font-bold text-xl text-slate-800 tracking-tight ml-2 border-l-2 border-slate-300 pl-3">Painel de Prioridades</span>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="bg-emerald-100 text-emerald-800 text-xs font-bold px-3 py-1.5 rounded-full uppercase tracking-wide flex items-center">
                        <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2 animate-pulse"></span> Base 2025 Conectada
                    </span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Global Filters Bar (Now Interactive) -->
    <div class="bg-white border-b border-gray-200 shadow-sm z-40 relative">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap gap-4 items-center">
            <span class="text-sm font-bold text-gray-700 mr-2">Filtros de Dados:</span>
            
            <select id="filterEstado" class="border border-gray-300 rounded-md text-sm px-3 py-1.5 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-700">
                <option value="Todos">Estado: Todos</option>
                <option value="CE">CE - Ceará</option>
                <option value="RS">RS - Rio Grande do Sul</option>
                <option value="RN">RN - Rio Grande do Norte</option>
                <option value="PE">PE - Pernambuco</option>
            </select>

            <select id="filterMunicipio" class="border border-gray-300 rounded-md text-sm px-3 py-1.5 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-700 disabled:opacity-50">
                <option value="Todos">Município: Todos</option>
                <!-- Populated dynamically -->
            </select>

            <select id="filterFrente" class="border border-gray-300 rounded-md text-sm px-3 py-1.5 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 text-gray-700">
                <option value="Todas">Frente: Todas</option>
                <option value="GEDU">GEDU (Educacional)</option>
                <option value="GESC">GESC (Escolar)</option>
                <option value="MOB">MOB (Mobilização)</option>
            </select>

            <button id="btnAplicarFiltros" class="ml-auto bg-slate-800 text-white border border-slate-900 px-6 py-1.5 rounded-md text-sm font-semibold hover:bg-slate-700 transition flex items-center shadow-sm">
                <span>Aplicar Filtros</span>
            </button>
        </div>
    </div>

    <!-- Hero Section -->
    <header class="bg-gradient-to-r from-slate-800 to-blue-900 text-white py-12">
        <div class="max-w-6xl mx-auto px-4 text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-3">Mapeamento de Prioridades de Desenvolvimento</h1>
            <p class="text-lg text-blue-100 max-w-3xl mx-auto opacity-90">
                Acompanhe a evolução da maturidade na Matriz de Competências em cada município e direcione as trilhas formativas de forma baseada em evidências.
            </p>
        </div>
    </header>

    <!-- Main Content Grid -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-16">

        <!-- SECTION 1: THEORY OF CHANGE & EXECUTIVE VIEW -->
        <section id="executive-view" class="space-y-6">
            <div class="border-l-4 border-blue-600 pl-4">
                <h2 class="text-3xl font-bold text-gray-900">1. Teoria da Mudança: Impacto e Resultados</h2>
                <p class="mt-2 text-lg text-gray-600">
                    Monitoramento dos indicadores finais (Aprendizagem) e dos resultados intermédios (Evolução da Matriz).
                </p>
            </div>

            <!-- KPIs Grid -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <!-- KPI 1: IMPACTO FINAL -->
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl shadow-md p-6 border border-blue-100 flex flex-col justify-center relative overflow-hidden fade-update">
                    <div class="absolute top-0 right-0 bg-blue-600 text-white text-[10px] px-2 py-1 font-bold rounded-bl uppercase tracking-wider">Métrica de Impacto</div>
                    <span class="text-gray-500 text-xs font-bold uppercase tracking-wider mt-2">Crescimento do Ideb</span>
                    <div class="flex items-end mt-2">
                        <span id="kpiIdeb" class="text-5xl font-bold text-blue-800">5.6</span>
                        <span class="text-sm text-gray-500 ml-2 mb-1">Média</span>
                    </div>
                </div>
                
                <!-- KPI 2: GESC -->
                <div id="cardGesc" class="bg-white rounded-xl shadow-sm p-6 border flex flex-col justify-center transition fade-update">
                    <span class="text-gray-400 text-xs font-bold uppercase tracking-wider">Maturidade GESC</span>
                    <span id="kpiGesc" class="text-4xl font-bold mt-2">3.47</span>
                    <span id="labelGesc" class="text-xs mt-1 font-bold inline-block px-2 py-1 rounded w-max mt-2">Consolidado</span>
                </div>
                
                <!-- KPI 3: GEDU -->
                <div id="cardGedu" class="bg-white rounded-xl shadow-sm p-6 border flex flex-col justify-center transition fade-update">
                    <span class="text-gray-400 text-xs font-bold uppercase tracking-wider">Maturidade GEDU</span>
                    <span id="kpiGedu" class="text-4xl font-bold mt-2">3.25</span>
                    <span id="labelGedu" class="text-xs mt-1 font-bold inline-block px-2 py-1 rounded w-max mt-2">Consolidado</span>
                </div>
                
                <!-- KPI 4: MOB -->
                <div id="cardMob" class="bg-white rounded-xl shadow-sm p-6 border flex flex-col justify-center relative transition fade-update">
                    <span class="text-gray-400 text-xs font-bold uppercase tracking-wider">Maturidade MOB</span>
                    <span id="kpiMob" class="text-4xl font-bold mt-2">2.53</span>
                    <span id="labelMob" class="text-xs mt-1 font-bold inline-block px-2 py-1 rounded w-max mt-2">Em Consolidação</span>
                </div>
            </div>

            <!-- Distribution Chart -->
            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 border border-gray-100 mt-6">
                <div class="mb-6 border-b border-gray-100 pb-4">
                    <h3 class="text-xl font-bold text-gray-800">Distribuição de Maturidade por Frente</h3>
                    <p class="text-sm text-gray-500">Contagem de municípios nos 4 níveis oficiais da Matriz (filtrado).</p>
                </div>
                <div class="chart-container h-80 md:h-[400px]">
                    <canvas id="chartDistribution"></canvas>
                </div>
            </div>
        </section>

        <!-- SECTION 2: HEATMAP -->
        <section id="heatmap-diagnosis" class="space-y-6">
            <div class="border-l-4 border-amber-500 pl-4">
                <h2 class="text-3xl font-bold text-gray-900">2. Mapa de Competências Interativo</h2>
                <p class="mt-2 text-lg text-gray-600">
                    Explore o panorama detalhado dos municípios. Identifique os perfis "Frágeis" que demandam urgência.
                </p>
            </div>

            <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                <div class="p-6 border-b border-gray-100 bg-gray-50 flex justify-between items-center flex-wrap gap-4">
                    <h3 id="heatmapTitle" class="font-bold text-lg text-gray-800">Recorte de Competências (Média Geral)</h3>
                    <div class="flex space-x-2 text-xs font-semibold">
                        <span class="px-2 py-1 bg-red-100 text-red-700 rounded border border-red-200">1. Frágil (< 2.5)</span>
                        <span class="px-2 py-1 bg-amber-100 text-amber-700 rounded border border-amber-200">2. Em Consolidação (2.5 - 2.9)</span>
                        <span class="px-2 py-1 bg-emerald-100 text-emerald-700 rounded border border-emerald-200">3. Consolidado (3.0 - 3.4)</span>
                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded border border-blue-200">4. Robusto (≥ 3.5)</span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-xs leading-normal">
                                <th class="py-3 px-6 text-left font-bold">Município (UF)</th>
                                <th class="py-3 px-6 text-center font-bold">C1</th>
                                <th class="py-3 px-6 text-center font-bold">C2</th>
                                <th class="py-3 px-6 text-center font-bold">C3</th>
                                <th class="py-3 px-6 text-center font-bold">C4</th>
                                <th class="py-3 px-6 text-center font-bold">C5</th>
                                <th class="py-3 px-6 text-center font-bold bg-slate-200">Média</th>
                            </tr>
                        </thead>
                        <tbody id="heatmapBody" class="text-gray-700 font-medium fade-update">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- SECTION 3: CLUSTERING & TRACKS -->
        <section id="clustering-intelligence" class="space-y-6">
            <div class="border-l-4 border-indigo-600 pl-4">
                <h2 class="text-3xl font-bold text-gray-900">3. Clusterização e Trilhas Formativas</h2>
                <p class="mt-2 text-lg text-gray-600">
                    O Motor de Dados agrupa os municípios para recomendar as Trilhas Oficiais do portefólio PVE 2026.
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                    <h3 class="font-bold text-lg text-gray-800 mb-2">Matriz de Clusters (GESC x GEDU)</h3>
                    <p class="text-xs text-gray-500 mb-6">Tamanho da Bolha: Maturidade MOB</p>
                    <div class="chart-container h-72 md:h-80">
                        <canvas id="chartClustering"></canvas>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-100 flex flex-col justify-center">
                    <h3 class="font-bold text-lg text-gray-800 mb-6 text-center">Recomendação Automática de Trilhas</h3>
                    <div class="flex flex-col items-center space-y-2 w-full max-w-sm mx-auto">
                        <div class="w-full p-4 bg-slate-50 border border-slate-200 rounded-lg text-center shadow-sm">
                            <span class="block text-xs font-bold text-slate-500 uppercase">Gatilho de Dados</span>
                            <span id="triggerText" class="block text-gray-800 font-bold text-sm">Cluster com Nível "Frágil"</span>
                        </div>
                        <div class="text-slate-300 text-xl">▼</div>
                        <div class="w-full p-5 bg-gradient-to-r from-blue-600 to-indigo-700 text-white border border-blue-800 rounded-lg text-center shadow-lg transition cursor-pointer">
                            <span class="block text-xs font-bold text-blue-200 uppercase tracking-widest mb-1">Trilha Recomendada</span>
                            <span id="recommendationText" class="block text-lg font-bold">Escolas Resilientes</span>
                            <span class="block text-xs text-blue-100 mt-2 font-medium bg-blue-800/50 inline-block px-2 py-1 rounded">Prioridade no Ciclo</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECTION 4: TERRITORY X-RAY -->
        <section id="territory-xray" class="space-y-6">
            <div class="border-l-4 border-cyan-500 pl-4">
                <h2 class="text-3xl font-bold text-gray-900">4. Raio-X do Território</h2>
                <p class="mt-2 text-lg text-gray-600">
                    Aprofundamento nas competências essenciais comparado com a média.
                </p>
            </div>

            <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 border border-gray-100">
                <div class="flex flex-col md:flex-row gap-8 items-center">
                    <div class="md:w-1/3 w-full">
                        <div class="chart-container h-80 md:h-96">
                            <canvas id="chartRadar"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <!-- MOTOR DE DADOS E LÓGICA DE INTERATIVIDADE -->
    <script>
        // ==========================================
        // 1. DATA ENGINE (Mock Data Database)
        // ==========================================
        // This simulates the data that would be fetched from Google Sheets.
        const dbData = [
            { uf: 'CE', municipio: 'Acaraú', gedu: 3.1, gesc: 3.2, mob_c1: 2.8, mob_c2: 2.5, mob_c3: 2.5, mob_c4: 2.6, mob_c5: 2.5 },
            { uf: 'CE', municipio: 'Bela Cruz', gedu: 3.5, gesc: 3.6, mob_c1: 3.3, mob_c2: 3.1, mob_c3: 3.0, mob_c4: 3.1, mob_c5: 2.9 },
            { uf: 'CE', municipio: 'Sobral', gedu: 3.8, gesc: 3.9, mob_c1: 3.5, mob_c2: 3.6, mob_c3: 3.8, mob_c4: 3.7, mob_c5: 3.5 },
            { uf: 'RS', municipio: 'Cidreira', gedu: 2.1, gesc: 2.3, mob_c1: 2.6, mob_c2: 1.8, mob_c3: 1.7, mob_c4: 1.9, mob_c5: 2.2 },
            { uf: 'RS', municipio: 'Tramandaí', gedu: 2.4, gesc: 2.5, mob_c1: 2.4, mob_c2: 2.1, mob_c3: 2.0, mob_c4: 2.1, mob_c5: 2.3 },
            { uf: 'RN', municipio: 'Extremoz', gedu: 2.5, gesc: 2.6, mob_c1: 2.0, mob_c2: 2.6, mob_c3: 2.9, mob_c4: 2.8, mob_c5: 2.1 },
            { uf: 'PE', municipio: 'Igarassu', gedu: 3.7, gesc: 3.8, mob_c1: 3.8, mob_c2: 3.7, mob_c3: 3.4, mob_c4: 3.6, mob_c5: 3.4 }
        ];

        // Computes average MOB from C1-C5 for each record
        dbData.forEach(row => {
            row.mob = Number(((row.mob_c1 + row.mob_c2 + row.mob_c3 + row.mob_c4 + row.mob_c5) / 5).toFixed(2));
        });

        /* // COMO CONECTAR AO SEU GOOGLE SHEETS REAL (Exemplo de Código)
        // Para usar isto, o Google Sheet deve estar "Publicado na Web" como CSV.
        function fetchFromGoogleSheets() {
            const csvUrl = 'https://docs.google.com/spreadsheets/d/1SZdTPeBSlq5_0RBCyzH_gUiZxTZpE53giOFHE26Z5nw/export?format=csv&gid=1233956697';
            Papa.parse(csvUrl, {
                download: true, header: true, dynamicTyping: true,
                complete: function(results) {
                    console.log("Dados do Sheets:", results.data);
                    // Aqui substituiria a variável dbData pelos results.data mapeados
                    // initializeApp(results.data);
                }
            });
        }
        */

        // ==========================================
        // 2. BUSINESS LOGIC (Maturity Levels)
        // ==========================================
        function getLevelInfo(score) {
            if(score < 2.5) return { label: 'Frágil', color: '#EF4444', bg: 'bg-red-50', text: 'text-red-700', border: 'border-red-200' };
            if(score < 3.0) return { label: 'Em Consolidação', color: '#F59E0B', bg: 'bg-amber-50', text: 'text-amber-700', border: 'border-amber-200' };
            if(score < 3.5) return { label: 'Consolidado', color: '#10B981', bg: 'bg-emerald-50', text: 'text-emerald-700', border: 'border-emerald-200' };
            return { label: 'Robusto', color: '#3B82F6', bg: 'bg-blue-50', text: 'text-blue-700', border: 'border-blue-200' };
        }

        // ==========================================
        // 3. UI STATE & INITIALIZATION
        // ==========================================
        let currentData = [...dbData];
        let chartInstances = {};

        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#475569';

        function initApp() {
            populateCityDropdown('Todos');
            initCharts();
            applyFilters(); // Initial render
            
            // Event Listeners
            document.getElementById('filterEstado').addEventListener('change', (e) => populateCityDropdown(e.target.value));
            document.getElementById('btnAplicarFiltros').addEventListener('click', applyFilters);
        }

        function populateCityDropdown(estado) {
            const select = document.getElementById('filterMunicipio');
            select.innerHTML = '<option value="Todos">Município: Todos</option>';
            
            const filteredCities = estado === 'Todos' ? dbData : dbData.filter(d => d.uf === estado);
            const uniqueCities = [...new Set(filteredCities.map(d => d.municipio))].sort();
            
            uniqueCities.forEach(city => {
                const opt = document.createElement('option');
                opt.value = city;
                opt.textContent = city;
                select.appendChild(opt);
            });
            select.disabled = false;
        }

        // ==========================================
        // 4. CORE UPDATE LOGIC
        // ==========================================
        function applyFilters() {
            const uf = document.getElementById('filterEstado').value;
            const municipio = document.getElementById('filterMunicipio').value;
            const frente = document.getElementById('filterFrente').value; // Usado para UI dinâmica

            currentData = dbData.filter(row => {
                return (uf === 'Todos' || row.uf === uf) && 
                       (municipio === 'Todos' || row.municipio === municipio);
            });

            if(currentData.length === 0) {
                alert("Nenhum dado encontrado para estes filtros.");
                return;
            }

            updateKPIs();
            updateHeatmap();
            updateCharts();
        }

        function getAvg(array, key) {
            const sum = array.reduce((acc, row) => acc + (row[key] || 0), 0);
            return Number((sum / array.length).toFixed(2));
        }

        function updateKPIs() {
            const avgGedu = getAvg(currentData, 'gedu');
            const avgGesc = getAvg(currentData, 'gesc');
            const avgMob = getAvg(currentData, 'mob');

            const setKpiUI = (idPrefix, score) => {
                const info = getLevelInfo(score);
                document.getElementById(`kpi${idPrefix}`).textContent = score;
                document.getElementById(`kpi${idPrefix}`).style.color = info.color;
                
                const label = document.getElementById(`label${idPrefix}`);
                label.textContent = info.label;
                label.className = `text-xs mt-1 font-bold inline-block px-2 py-1 rounded w-max mt-2 border ${info.bg} ${info.text} ${info.border}`;
                
                const card = document.getElementById(`card${idPrefix}`);
                card.className = `bg-white rounded-xl shadow-sm p-6 border flex flex-col justify-center transition fade-update border-l-4`;
                card.style.borderLeftColor = info.color;
            };

            setKpiUI('Gedu', avgGedu);
            setKpiUI('Gesc', avgGesc);
            setKpiUI('Mob', avgMob);

            // Update recommendation engine text dynamically based on worst performing area
            const minAvg = Math.min(avgGedu, avgGesc, avgMob);
            const trigger = document.getElementById('triggerText');
            const rec = document.getElementById('recommendationText');
            
            if (minAvg === avgMob && minAvg < 3.0) {
                trigger.textContent = 'Maturidade MOB em Risco';
                rec.textContent = 'Escolas Resilientes';
            } else if (minAvg === avgGedu && minAvg < 3.0) {
                trigger.textContent = 'Maturidade GEDU em Risco';
                rec.textContent = 'Gestão da Aprendizagem';
            } else {
                trigger.textContent = 'Rede Consolidada';
                rec.textContent = 'Disseminação de Boas Práticas';
            }
        }

        function updateHeatmap() {
            const tbody = document.getElementById('heatmapBody');
            tbody.innerHTML = '';
            
            currentData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-100 hover:bg-gray-50 transition';
                
                const cols = [row.mob_c1, row.mob_c2, row.mob_c3, row.mob_c4, row.mob_c5, row.mob];
                let html = `<td class="py-3 px-6 text-left whitespace-nowrap font-bold text-gray-800">${row.municipio} (${row.uf})</td>`;
                
                cols.forEach(val => {
                    const info = getLevelInfo(val);
                    html += `<td class="py-3 px-6 text-center ${info.bg} ${info.text} font-bold border-x border-white">${val.toFixed(2)}</td>`;
                });
                
                tr.innerHTML = html;
                tbody.appendChild(tr);
            });
        }

        // ==========================================
        // 5. CHART.JS MANAGEMENT
        // ==========================================
        const tooltipCb = {
            title: (items) => Array.isArray(items[0].chart.data.labels[items[0].dataIndex]) ? items[0].chart.data.labels[items[0].dataIndex].join(' ') : items[0].chart.data.labels[items[0].dataIndex]
        };

        function initCharts() {
            // Dist Chart
            chartInstances.dist = new Chart(document.getElementById('chartDistribution'), {
                type: 'bar',
                data: { labels: ['GEDU', 'GESC', 'MOB'], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true, title: {display: true, text: 'Nº Municípios'} } }
                }
            });

            // Cluster Chart
            chartInstances.cluster = new Chart(document.getElementById('chartClustering'), {
                type: 'bubble',
                data: { datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { title: {display: true, text: 'GESC'}, min: 1, max: 4 }, y: { title: {display: true, text: 'GEDU'}, min: 1, max: 4 } },
                    plugins: { tooltip: { callbacks: { label: (c) => `${c.raw.municipio}: GESC ${c.raw.x}, GEDU ${c.raw.y}` } } }
                }
            });

            // Radar Chart
            chartInstances.radar = new Chart(document.getElementById('chartRadar'), {
                type: 'radar',
                data: { labels: ['C1', 'C2', 'C3', 'C4', 'C5'], datasets: [] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { min: 1, max: 4, ticks: {display: false} } }
                }
            });
        }

        function updateCharts() {
            // 1. Distribution Logic
            const levels = {
                fragil: { label: 'Nível 1: Frágil', color: '#EF4444', data: [0,0,0] },
                cons: { label: 'Nível 2: Em Consolidação', color: '#F59E0B', data: [0,0,0] },
                consolidado: { label: 'Nível 3: Consolidado', color: '#10B981', data: [0,0,0] },
                robusto: { label: 'Nível 4: Robusto', color: '#3B82F6', data: [0,0,0] }
            };

            currentData.forEach(row => {
                ['gedu', 'gesc', 'mob'].forEach((frente, idx) => {
                    const score = row[frente];
                    if(score < 2.5) levels.fragil.data[idx]++;
                    else if(score < 3.0) levels.cons.data[idx]++;
                    else if(score < 3.5) levels.consolidado.data[idx]++;
                    else levels.robusto.data[idx]++;
                });
            });

            chartInstances.dist.data.datasets = Object.values(levels).map(l => ({
                label: l.label, data: l.data, backgroundColor: l.color, barThickness: 50
            }));
            chartInstances.dist.update();

            // 2. Clustering Logic
            const clusters = {
                fragil: { label: 'Atenção (Frágil)', color: 'rgba(239, 68, 68, 0.7)', border: '#B91C1C', data: [] },
                cons: { label: 'Intermédio', color: 'rgba(245, 158, 11, 0.7)', border: '#B45309', data: [] },
                destaque: { label: 'Destaque', color: 'rgba(16, 185, 129, 0.7)', border: '#047857', data: [] }
            };

            currentData.forEach(row => {
                const point = { x: row.gesc, y: row.gedu, r: Math.max(5, row.mob * 4), municipio: row.municipio };
                if(row.mob < 2.5) clusters.fragil.data.push(point);
                else if(row.mob < 3.0) clusters.cons.data.push(point);
                else clusters.destaque.data.push(point);
            });

            chartInstances.cluster.data.datasets = Object.values(clusters).map(c => ({
                label: c.label, data: c.data, backgroundColor: c.color, borderColor: c.border, borderWidth: 1
            }));
            chartInstances.cluster.update();

            // 3. Radar Logic (Avg of current selection)
            const avgC = [
                getAvg(currentData, 'mob_c1'), getAvg(currentData, 'mob_c2'),
                getAvg(currentData, 'mob_c3'), getAvg(currentData, 'mob_c4'),
                getAvg(currentData, 'mob_c5')
            ];
            
            const labelText = currentData.length === 1 ? currentData[0].municipio : `Média Seleção (${currentData.length})`;

            chartInstances.radar.data.datasets = [{
                label: labelText,
                data: avgC,
                fill: true, backgroundColor: 'rgba(6, 182, 212, 0.2)', borderColor: '#06B6D4',
                pointBackgroundColor: '#06B6D4', borderWidth: 2
            }];
            chartInstances.radar.update();
        }

        // Boot
        window.onload = initApp;
    </script>
</body>
</html>